name: CD

on:
  workflow_run:
    workflows: ["CI"]
    branches: ["main"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SPM_HOST }}
          username: ${{ secrets.SPM_USER }}
          key: ${{ secrets.SPM_SSH_KEY }}
          port: ${{ secrets.SPM_PORT }}
          script: |
            set -e
            cd ${{ secrets.SPM_APP_DIR }}
            export PORT=${{ secrets.SPM_APP_PORT }}
            if command -v nvm >/dev/null 2>&1; then
              nvm install 20
              nvm use 20
            elif [ -s "$HOME/.nvm/nvm.sh" ]; then
              . "$HOME/.nvm/nvm.sh"
              nvm install 20
              nvm use 20
            else
              curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
              . "$HOME/.nvm/nvm.sh"
              nvm install 20
              nvm use 20
            fi
            git fetch --all
            git reset --hard origin/main
            npm ci --omit=optional
            npm run build
            if command -v pm2 >/dev/null 2>&1; then
              pm2 restart recipe-webapp || pm2 start npm --name recipe-webapp -- start
            elif command -v systemctl >/dev/null 2>&1; then
              sudo systemctl restart recipe-webapp
            else
              echo "No process manager found. Please restart the app manually."
            fi
